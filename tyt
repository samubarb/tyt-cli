#!/bin/sh
# Take Your Token CLI

options="Options:
    help            This help menu.
    config          Prompt email and password dialog and save them to a local file.
    buy [item]      Buy something [coffee | beer | redbull | tea].
    add [number]    Add tokens to your wallet.
    token           Shows your left tokens.

    Welcome in Take Your Token CLI.
    A token costs 30 eurocents. Here are some examples of euro/token change.
                    
                    ------------------
                      Euro  | Tokens  
                    --------+---------
                      3.00  |   10   
                      4.50  |   15   
                      5.10  |   17   
                      6.00  |   20   
                     10.20  |   34   
                     20.40  |   68   
                     30.00  |   100  
                     99.00  |   330
                    "

# Check if grep is installed
if ! command -v grep >/dev/null; then
    echo "Install 'grep' package."
fi

# Check if curl is installed
if ! command -v curl >/dev/null; then
    echo "Install 'curl' package."
fi

# Check if cut is available
if ! command -v cut >/dev/null; then
    echo "Install 'coreutils' package."
fi

# Set userfile path
userfile="$HOME/tyt-cli/user"

if [ -f $userfile ]; then
    source $userfile
elif [ "$1" == "c" ] || [ "$1" == "config" ]; then
        continue
else
    echo "First usage. Run 'tyt config' to configure your user and password."
    exit 1
fi

# Declare constant strings
domain=https://takeyourtoken.necst.it
match="302 FOUND"

COFFEE="Caff√©"
TEA="The"
REDBULL="Red bull"
BEER="Carlsberg"


# Declare functions
function buy {
    case "$1" in
        c|coffee)
            item=$COFFEE
            ;;
        b|beer)
            item=$BEER
            ;;
        r|redbull)
            item=$REDBULL
            ;;
        t|tea)
            item=$TEA
            ;;
        *) echo "Not a valid item." ; exit 1 ;;
    esac

    res=$(curl -s -i --cookie "session=$cookie" -d "buy=$item" -X POST "$domain/buy_product")
    grep -i "token left" <<< $res | cut -d"!" -f1 | cut -d">" -f3
}

function login {
    # Login here and take POST header
    res=$(curl -s -i -d "email=$email&password=$password" -X POST "$domain/login")

    if echo "$res" | grep -q "$match"; then
        # Isolate cookie 
        cookie=$(grep -i set-cookie <<< "$res" | cut -d"=" -f2 | cut -d";" -f1)
    else
      echo "Wrong username or password. Otherwise $domain is down."
      exit 1
    fi
}


# Input parsing
case "$1" in
    h|help|"") printf "Usage: %s [options]\n\n%s\n\n" "${0##*/}" "$options"; exit 1 ;;
    
    c|config)
        echo -n Email:
        read email
        echo -n Password: 
        read -s password
        echo email="$email" > user
        echo password="$password" >> user
        echo
        exit 0
        ;;
    
    b|buy)
        login
        # Buy selected item
        buy "$2"
        ;;

    a|add)
        login
        # Add tokens
        res=$(curl -s -i --cookie "session=$cookie" -d "tokennumber=$2" -X POST "$domain/add_token")
        grep -i "token left" <<< $res | cut -d"!" -f1 | cut -d">" -f3
        ;;

    t|token)
        login
        # Get user dashboard page to retrieve token number
        res=$(curl -s -i --cookie "session=$cookie" -X GET "$domain/user_dash")
        grep -i "token left" <<< $res | cut -d"!" -f1 | cut -d">" -f3
        ;;


    *) echo "Not a valid command." ; exit 1 ;;
esac
